--- src/src/util.cc.orig
+++ src/src/util.cc
@@ -880,8 +880,23 @@
   }
 #endif
   if (cgroupCount >= 0 && schedCount >= 0) return std::min(cgroupCount, schedCount);
-  if (cgroupCount < 0 && schedCount < 0)
+  if (cgroupCount < 0 && schedCount < 0) {
+#ifdef _SC_NPROCESSORS_ONLN
     return static_cast<int>(sysconf(_SC_NPROCESSORS_ONLN));
+#elif defined(CTL_HW) && defined(HW_NCPU)
+    int mib[2], ncpus = 0;
+    mib[0]     = CTL_HW;
+    mib[1]     = HW_NCPU;
+    size_t len = sizeof(ncpus);
+    sysctl(mib, 2, &ncpus, &len, NULL, 0);
+    if (ncpus < 1)
+      return 1;
+    return ncpus;
+#else
+#warning no way to determine cpu count
+    return 1;
+#endif
+  }
   return std::max(cgroupCount, schedCount);
 #endif
 }
