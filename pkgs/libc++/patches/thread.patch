--- src/libcxx/src/thread.cpp.orig
+++ src/libcxx/src/thread.cpp
@@ -20,6 +20,10 @@
 #  include <unistd.h> // for sysconf
 #endif
 
+#if __has_include(<sys/sysctl.h>)
+#  include <sys/sysctl.h>
+#endif
+
 #if defined(__NetBSD__)
 #  pragma weak pthread_create // Do not create libpthread dependency
 #endif
@@ -75,7 +79,16 @@
   return static_cast<unsigned>(result);
 #elif defined(_LIBCPP_WIN32API)
   return static_cast<unsigned>(GetActiveProcessorCount(ALL_PROCESSOR_GROUPS));
-#else // defined(CTL_HW) && defined(HW_NCPU)
+#elif defined(CTL_HW) && defined(HW_NCPU)
+  int mib[2], ncpus = 0;
+  mib[0]     = CTL_HW;
+  mib[1]     = HW_NCPU;
+  size_t len = sizeof(ncpus);
+  sysctl(mib, 2, &ncpus, &len, NULL, 0);
+  if (ncpus < 1)
+    return 1;
+  return ncpus;
+#else
   // TODO: grovel through /proc or check cpuid on x86 and similar
   // instructions on other architectures.
 #  if defined(_LIBCPP_WARNING)
